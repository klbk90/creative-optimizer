# ğŸ”— S2S Tracking Flow - ĞšĞ°Ğº ÑĞ²ÑĞ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ

## ğŸ“Š ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ±ĞµĞ· ĞºÑƒĞºĞ¸ (Server-to-Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: TikTok Click                         â”‚
â”‚                                                                 â”‚
â”‚  TikTok bio: yourdomain.com/l/tiktok_abc123                    â”‚
â”‚                                                                 â”‚
â”‚  âŒ ĞĞ• Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼:                                                â”‚
â”‚     - TikTok user_id                                           â”‚
â”‚     - TikTok username                                          â”‚
â”‚     - Ğ’Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ ÑĞ·ĞµÑ€Ğ° Ğ² TikTok                         â”‚
â”‚                                                                 â”‚
â”‚  âœ… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ (S2S):                                             â”‚
â”‚     - utm_id: "tiktok_abc123"                                  â”‚
â”‚     - IP: "95.123.45.67"                                       â”‚
â”‚     - User-Agent: "Mozilla/5.0 (iPhone...)"                    â”‚
â”‚     - Referrer: "https://www.tiktok.com/"                      â”‚
â”‚     - Device: "mobile"                                         â”‚
â”‚     - Country: "RU" (via GeoIP)                                â”‚
â”‚     - City: "Moscow" (via GeoIP)                               â”‚
â”‚     - Timestamp: 2025-01-06 15:30:00                           â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ‘Ğ”:                                             â”‚
â”‚     TrafficSource {                                            â”‚
â”‚       utm_id: "tiktok_abc123",                                 â”‚
â”‚       utm_source: "tiktok",                                    â”‚
â”‚       utm_campaign: "football_jan_2025",                       â”‚
â”‚       clicks: 1,                                               â”‚
â”‚       ip_address: "95.123.45.67",                              â”‚
â”‚       country: "RU",                                           â”‚
â”‚       device_type: "mobile"                                    â”‚
â”‚     }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                STEP 2: Landing Page (3 sec)                     â”‚
â”‚                                                                 â”‚
â”‚  ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼:                                                   â”‚
â”‚  - Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ ĞºĞ°Ğ½Ğ°Ğ»Ğ°                                              â”‚
â”‚  - ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ                                                    â”‚
â”‚  - "Redirecting to Telegram..."                                â”‚
â”‚                                                                 â”‚
â”‚  Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚:                                                     â”‚
â”‚  â†’ t.me/your_bot?start=tiktok_abc123  â† UTM ID Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½!       â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”’ ĞšÑƒĞºĞ¸ ĞĞ• Ğ½ÑƒĞ¶Ğ½Ñ‹! UTM ID Ğ² URL!                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               STEP 3: Telegram Bot /start                       â”‚
â”‚                                                                 â”‚
â”‚  Telegram Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ±Ğ¾Ñ‚Ñƒ:                                     â”‚
â”‚  /start tiktok_abc123                                          â”‚
â”‚                                                                 â”‚
â”‚  âœ… Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞĞ¢ TELEGRAM:                                   â”‚
â”‚     - telegram_user_id: 123456789                              â”‚
â”‚     - username: @john_doe                                      â”‚
â”‚     - first_name: "John"                                       â”‚
â”‚     - language_code: "ru"                                      â”‚
â”‚                                                                 â”‚
â”‚  âœ… Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°:                                  â”‚
â”‚     - utm_id: "tiktok_abc123"                                  â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¾ Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼ (Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ Ğ‘Ğ”):                                â”‚
â”‚     user_utm_mapping[123456789] = "tiktok_abc123"              â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“¡ ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Track click                                    â”‚
â”‚     POST /api/v1/utm/track/click                               â”‚
â”‚     {                                                          â”‚
â”‚       "utm_id": "tiktok_abc123",                               â”‚
â”‚       "user_id": 123456789,                                    â”‚
â”‚       "referrer": "telegram_bot_start"                         â”‚
â”‚     }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                STEP 4: ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° Lootbox                          â”‚
â”‚                                                                 â”‚
â”‚  Ğ®Ğ·ĞµÑ€ (telegram_user_id=123456789) Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°ĞµÑ‚ Ğ·Ğ° $50            â”‚
â”‚                                                                 â”‚
â”‚  Ğ‘Ğ¾Ñ‚:                                                          â”‚
â”‚    utm_id = user_utm_mapping[123456789]  # "tiktok_abc123"    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“¡ Webhook Ğ½Ğ° Tracking API:                                    â”‚
â”‚     POST /api/v1/utm/webhook/conversion                        â”‚
â”‚     {                                                          â”‚
â”‚       "utm_id": "tiktok_abc123",                               â”‚
â”‚       "customer_id": "telegram_123456789",                     â”‚
â”‚       "amount": 5000,  // $50.00                               â”‚
â”‚       "product_name": "Gold Lootbox"                           â”‚
â”‚     }                                                          â”‚
â”‚                                                                 â”‚
â”‚  API Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚:                                                  â”‚
â”‚    TrafficSource.where(utm_id="tiktok_abc123")                 â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¾ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚:                                                  â”‚
â”‚    TrafficSource {                                             â”‚
â”‚      conversions: 1,                                           â”‚
â”‚      revenue: 5000  // cents                                   â”‚
â”‚    }                                                           â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Conversion:                                         â”‚
â”‚    Conversion {                                                â”‚
â”‚      traffic_source_id: uuid,                                 â”‚
â”‚      customer_id: "telegram_123456789",                        â”‚
â”‚      amount: 5000,                                             â”‚
â”‚      time_to_conversion: 3600  // 1 Ñ‡Ğ°Ñ Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞºĞ°              â”‚
â”‚    }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Ğ§Ñ‚Ğ¾ Ğ¼Ñ‹ Ğ·Ğ½Ğ°ĞµĞ¼ Ğ² Ğ¸Ñ‚Ğ¾Ğ³Ğµ:

### ĞŸĞ¾ utm_id="tiktok_abc123":

```json
{
  "utm_source": "tiktok",
  "utm_campaign": "football_jan_2025",
  "utm_content": "video_messi_goal",

  "first_click": "2025-01-06 15:30:00",
  "ip": "95.123.45.67",
  "country": "RU",
  "city": "Moscow",
  "device": "mobile",
  "browser": "Safari",

  "telegram_user_id": 123456789,
  "telegram_username": "@john_doe",

  "conversion": {
    "amount": 5000,
    "time_to_conversion": 3600,
    "product": "Gold Lootbox"
  }
}
```

### âœ… Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼:

```
TikTok video (video_messi_goal)
  â†’ IP 95.123.45.67 (Moscow, Russia, iPhone)
    â†’ Telegram user 123456789 (@john_doe)
      â†’ ĞšÑƒĞ¿Ğ¸Ğ» Gold Lootbox Ğ·Ğ° $50
        â†’ Ğ§ĞµÑ€ĞµĞ· 1 Ñ‡Ğ°Ñ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ»Ğ¸ĞºĞ°
```

### âŒ Ğ§ĞµĞ³Ğ¾ ĞĞ• Ğ·Ğ½Ğ°ĞµĞ¼ (Ğ¸ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ ÑƒĞ·Ğ½Ğ°ĞµĞ¼ Ğ±ĞµĞ· OAuth):

```
- TikTok user_id
- TikTok username
- ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ Ğ»Ğ¸ Ğ½Ğ° Ğ½Ğ°Ñ Ğ² TikTok
```

---

## ğŸª ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ ĞºÑƒĞºĞ¸ ĞĞ• Ğ¿Ğ¾Ğ¼Ğ¾Ğ³ÑƒÑ‚:

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ Ñ ĞºÑƒĞºĞ¸ (ĞĞ• Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚):

```
1. yourdomain.com ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ cookie: user_id=abc123
2. Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° telegram.org
3. âŒ telegram.org ĞĞ• ĞœĞĞ–Ğ•Ğ¢ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞºÑƒĞºĞ¸ Ñ yourdomain.com
4. âŒ Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½Ñ‹ = Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ cookie jars
```

### ĞĞ°ÑˆĞµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ (S2S):

```
1. yourdomain.com/l/tiktok_abc123 â† UTM ID Ğ² URL
2. Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ‘Ğ”: utm_id + IP + device
3. Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚: t.me/bot?start=tiktok_abc123 â† UTM ID Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½!
4. Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚: telegram_user_id + utm_id
5. Webhook: utm_id + Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ°
6. âœ… Ğ’ÑĞµ ÑĞ²ÑĞ·Ğ°Ğ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· UTM ID!
```

---

## ğŸ” S2S = Server-to-Server:

```
Server 1 (Landing)        Server 2 (Bot)          Server 3 (API)
      â†“                        â†“                        â†“
   ĞšĞ»Ğ¸Ğº + UTM ID  â†’  /start + UTM ID  â†’  Webhook + UTM ID
      â†“                        â†“                        â†“
  Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ‘Ğ”     Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ User    ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ‘Ğ”
```

**ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… ĞºÑƒĞºĞ¸! Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹!**

---

## ğŸ’¡ ĞšĞ°Ğº ÑĞ²ÑĞ·Ğ°Ñ‚ÑŒ TikTok User ID (ĞµÑĞ»Ğ¸ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ½ÑƒĞ¶Ğ½Ğ¾):

### Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± - OAuth:

```python
@bot.message_handler(commands=['link_tiktok'])
def link_tiktok(message):
    """
    ĞŸÑ€Ğ¾ÑĞ¸Ğ¼ ÑĞ·ĞµÑ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ñ‡ĞµÑ€ĞµĞ· TikTok.
    """
    oauth_url = generate_tiktok_oauth_url(
        redirect_uri="https://yourdomain.com/tiktok/callback",
        state=f"telegram_{message.from_user.id}"
    )

    bot.send_message(
        message.chat.id,
        f"ĞŸÑ€Ğ¸Ğ²ÑĞ¶Ğ¸ ÑĞ²Ğ¾Ğ¹ TikTok: {oauth_url}"
    )

# ĞŸĞ¾ÑĞ»Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ TikTok Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ñ‚ Ğ½Ğ°:
# https://yourdomain.com/tiktok/callback?code=xxx&state=telegram_123456789

# ĞĞ±Ğ¼ĞµĞ½Ğ¸Ğ²Ğ°ĞµĞ¼ code Ğ½Ğ° access_token
# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ TikTok user_id
# Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼: telegram_user_id â†” tiktok_user_id
```

**ĞĞ¾ ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³Ğ° ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ğ¹!**

---

## âœ… Ğ˜Ñ‚Ğ¾Ğ³Ğ¾:

1. **UTM ID = ÑĞ²ÑĞ·ÑƒÑÑ‰ĞµĞµ Ğ·Ğ²ĞµĞ½Ğ¾** (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ‘Ğ•Ğ— ĞºÑƒĞºĞ¸!)
2. **S2S Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³ = ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ°Ñ ÑĞ²ÑĞ·ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· Ğ‘Ğ”**
3. **TikTok User ID = Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±ĞµĞ· OAuth**
4. **Telegram User ID = Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ‚ Telegram API**

**Ğ¡Ğ²ÑĞ·ĞºĞ°:**
```
UTM ID â†’ ĞšĞ»Ğ¸Ğº â†’ Telegram User ID â†’ ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ°
```

Ğ’ÑĞµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚! ğŸš€
